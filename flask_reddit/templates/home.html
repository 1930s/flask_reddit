{% extends "base.html" %}

{% block content %}
<div class="col-lg-9">
  {% block left %}
      {% for thread in threads %}
        <div class="row listing-row">
          <div class="col-lg-1 listing-vote-box">  
              <a href="{{ config.ROOT_URL }}/api/upvote/{{ thread.id }}" 
                  class="listing-vote-box">â–²</a>
          </div>
          <div class="col-lg-9 listing-text">  
              {% if thread.link %}
              <a href="{{ thread.link }}" class="listing-title">
              {% else %}
              <a href="{{ config.ROOT_URL }}/threads/{{ thread.id }}/{{ thread.title|truncate(100)|replace(' ',       '_') }}" class="listing-title">
              {% endif %}
                <h4>{{ thread.title }}</h4>
              </a>

              <div class="post-listing-meta">
                  <a href="{{ config.ROOT_URL }}/threads/{{ thread.id }}/{{ thread.title|truncate(100)|replace(' ', '_') }}">
                  {{ thread.comments.all()|length() }} comments</a>,
                  {{ thread.pretty_date() }}, by 
                  <a href="{{ url_for('users.home_page', 
                        username=thread.user.username) }}">
                  {{ thread.user.username }}</a>
              </div>
          </div>
        </div>
      {% endfor %}
  {% endblock %}
</div>

<div class="col-lg-3">
  {% block right %}
    {% if user is defined and user != None %}
        <a href="{{ config.ROOT_URL }}/threads/submit"><button class="btn btn-primary">
                Submit a post</button></a>
    {% else %}
        <h4>Please register or login to post!</h4>
    {% endif %}
    <hr>
    <h3>List of subreddits</h3>
    <ul>
        <li></li>
        <li></li>
    </ul>
  {% endblock %}
</div>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
window.onload = (function() {
    $(document).ready(function() {
        // $(".btn-custom").click(function() {  
        //     $(this).parent().next("div.proof_box").toggle('blind'); 
        // });
        $('button.submit-comment').click(function() {
            // We will submit user id data via session.
            // Don't need to include parent comment because we are commenting 
            // on a thread, not a comment!
            var parent_id = "";
            var not_nested =  $(this).hasClass('main-submit').toString();
            // the logic is funky because we are using string booleans...
            if (not_nested == 'false') {
                // it is nested 
                parent_id = $(this).parent('div.comments-element').attr('name');
            } else {
                // it isn't nested
            }
            var thread_id = "{{ thread.id }}";
            var comment_text = $(this).parent('div.comment-form-parent').children(
                'textarea.thread-comment-box').val();
            var post_to = '/api/comments/submit/';
            {% if user is defined and user != None %}
                $.post(post_to, { 
                    parent_id: parent_id, // empty if top-level (none)
                    thread_id: thread_id, 
                    comment_text: comment_text },
                    function(response) {
                        $('div.comments-tree').prepend(
                            '<div class="row comments-element">' +
                            '<p>' + response.comment_text + '</p>' + 
                            '<br>' +
                            '<div class="post-listing-meta">' + 
                            'by: ' + response.username + ' - ' + response.date +
                            '</div>'
                        );
                    }, 'json'
                )              
            {% else %}
                alert("You must be logged in to do that!");
            {% endif %}
        });
    });
});
</script>
{% endblock %}
